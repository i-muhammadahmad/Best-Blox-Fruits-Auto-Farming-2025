import React, { useState, useEffect } from 'react';
import { useSelector, useDispatch } from 'react-redux';
import validate from 'validate.js';
import { makeStyles } from '@material-ui/styles';
import { Page, StyledFab, StyledButton } from 'components';
import {
  Header,
  ExtraFieldModel
} from './components';
import { 
  updateBulkActivitySetup,
  hideBulkActivitySetupValidationError,
  addRemoveBulkExtraField,
  redirectToBulkActivitySetupList
} from 'actions'
import { 
  Card, 
  CardHeader, 
  CardContent,
  TextField,
  Grid,
  FormControl,
  FormHelperText,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
 } from '@material-ui/core';
import CloseIcon from '@material-ui/icons/Close';
import Autocomplete from '@material-ui/lab/Autocomplete';
import CKEditor from '@ckeditor/ckeditor5-react'
import ClassicEditor from 'ckeditor5-custom-build/build/ckeditor';
import { isEmpty, find, remove, each, some, includes, has } from 'lodash';
import useRouter from 'utils/useRouter';
import AddCircleOutlineIcon from '@material-ui/icons/AddCircleOutline';
import SaveIcon from '@material-ui/icons/Save';
import CancelIcon from '@material-ui/icons/Cancel';
import { CK_CONFIGS } from 'configs';
import { ClientDropdown } from 'commonDropdowns';

const schema = {
  name: {
    presence: { allowEmpty: false, message: 'is required' },
  },
  client_id: {
    presence: { allowEmpty: false, message: 'is required' },
  }
}

const useStyles = makeStyles(theme => ({
  root: {
    width: theme.breakpoints.values.lg,
    maxWidth: '100%',
    margin: '0 auto',
    padding: theme.spacing(3, 3, 6, 3)
  },
  projectDetails: {
    marginTop: theme.spacing(3)
  },
  formGroup: {
    marginBottom: theme.spacing(3)
  }
}));

const BulkActivitySetupUpdate = () => {
  const classes = useStyles();
  const dispatch = useDispatch();
  const router = useRouter();
  const bulkActivitySetupState = useSelector(state => state.bulkActivitySetupState);
  const session = useSelector(state => state.session);

  const [ClientValue, setClientValue] = useState(null);
  const [openExtraFieldModel, setOpenExtraFieldModel] = React.useState(false);
  const [formState, setFormState] = useState({
    isValid: false,
    values: {
      'object_viewed_id': session.current_page_permissions.object_id,
    },
    touched: {
      'object_viewed_id': true,
    },
    errors: {}
  });

  useEffect(() => {
    const errors = validate(formState.values, schema);
    setFormState(formState => ({
      ...formState,
      isValid: errors ? false : true,
      errors: errors || {}
    }));
  }, [formState.values]);

  useEffect(() => {
    if(!isEmpty(bulkActivitySetupState.validation_error)){
      const errors = bulkActivitySetupState.validation_error;
      setFormState(formState => ({
        ...formState,
        isValid: errors ? false : true,
        errors: errors || {}
      }));
    }  
  }, [bulkActivitySetupState.validation_error]);

  useEffect(()=> {
    if(!bulkActivitySetupState.showUpdateForm){
      router.history.push('/bulk-activity-setup');
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  },[bulkActivitySetupState.showUpdateForm]);

  useEffect(() => {
    if(bulkActivitySetupState.redirect_to_list){
      router.history.push('/bulk-activity-setup');
    } 
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [bulkActivitySetupState.redirect_to_list]);

  //populate form data
  useEffect(() => {

    if(!isEmpty(bulkActivitySetupState.availableExtraFields)){
      let record = bulkActivitySetupState.bulkActivitySetupRecord
      
      let touch = {...formState.touched};
      let vals = {...formState.values};

      let av_fields = bulkActivitySetupState.availableExtraFields;
      let ad_fields = bulkActivitySetupState.addedExtraFields;

      //fill extra field data
      each( record.extra_fields, ( val, key ) => { 
        if(!isEmpty(val)){
          vals[key] = val.log_field;
          touch[key] = true;
          let item = find(av_fields, ['name', val.log_field]);
          item = {
            ...item,
            'id': val.id,
            'field_label': val.label
          }
          ad_fields.push(item);
          remove(av_fields, ['name', val.log_field]);
        }          
      });

      //fill form data
      each( record, ( val, key ) => { 
        if(some(['id', 'name', 'client_id', 'description'], (el) => includes(key, el))){
          vals[key] = val;
          touch[key] = true;
        }
      });  

      //set form state
      setFormState(formState => ({
        ...formState,
        values: vals,
        touched: touch
      }));
      dispatch(addRemoveBulkExtraField(av_fields, ad_fields)); 
    } 
      
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [bulkActivitySetupState.availableExtraFields, bulkActivitySetupState.bulkActivitySetupRecord]);

  useEffect(() => { 
    if(!isEmpty(bulkActivitySetupState.addedExtraFields)){
      bulkActivitySetupState.addedExtraFields.map(added_extraField => {
        const stat = (formState) => {
          let field = added_extraField.name;
          let f_label = added_extraField.field_label;
          
          let vals = {...formState.values};
          vals[field] = f_label;

          let touch = {...formState.touched};
          touch[field] = true;
          return {
            ...formState,
            values: vals,
            touched: touch
          }  
        }
        setFormState(stat);
        return true;
      })
    }  
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [bulkActivitySetupState.addedExtraFields.length]);

  const clientOnChange = (event, newValue) => {
    if(newValue){
      setClientValue(newValue)
      setClientId(newValue.id)
    }
    else{
      setClientValue(newValue)
      setClientId('')
    }
  }

  const setClientId = client_id => {
    setFormState(formState => ({
      ...formState,
      values: {
        ...formState.values,
        'client_id':client_id
      },
      touched: {
        ...formState.touched,
        'client_id': true
      }
    }));
    dispatch(hideBulkActivitySetupValidationError('client_id'))
  }

  const setDescription = description => {
    setFormState(formState => ({
      ...formState,
      values: {
        ...formState.values,
        'description':description
      },
      touched: {
        ...formState.touched,
        'description': true
      }
    }));
    dispatch(hideBulkActivitySetupValidationError('description'))
  }

  const handleChange = event => {
    event.persist();

    setFormState(formState => ({
      ...formState,
      values: {
        ...formState.values,
        [event.target.name]:
          event.target.type === 'checkbox'
            ? event.target.checked
            : event.target.value
      },
      touched: {
        ...formState.touched,
        [event.target.name]: true
      }
    }));
    dispatch(hideBulkActivitySetupValidationError(event.target.name))
  }

  const handleSubmit = async event => {
    event.preventDefault();
    let Formdata = {
      ...formState.values,
      extraFields: bulkActivitySetupState.addedExtraFields,
      removed_fields: bulkActivitySetupState.removedExtraFields
    };
    dispatch(updateBulkActivitySetup(Formdata));
  }

  const hasError = field =>
    formState.touched[field] && formState.errors[field] ? true : false;

  const removeExtraField = (field_name) => {
    let a_fields = bulkActivitySetupState.availableExtraFields;
    let added_fields = bulkActivitySetupState.addedExtraFields;
    let removed_fields = bulkActivitySetupState.removedExtraFields;
    const item = find(added_fields, ['name', field_name]);
    a_fields.push(item);
    remove(added_fields, ['name', field_name]);

    //adding item to removed list
    if(has(item, 'id')){
      removed_fields.push(item);
    }

    dispatch(addRemoveBulkExtraField(a_fields, added_fields, removed_fields));

    let touch = {...formState.touched};
    delete touch[field_name];

    let vals = {...formState.values};
    delete vals[field_name];
    setFormState(formState => ({
      ...formState,
      values: vals,
      touched: touch
    }));
  }
  
  return (
    <Page
      className={classes.root}
      title="Update Activities Import Setup"
    >
      <Header />
      <Card
        className={classes.projectDetails}
      >
        <CardHeader title="Update Activities Import Setup" />
        <CardContent>
        <form
          onSubmit={handleSubmit}
        >
          <div className={classes.formGroup}>
            <Grid container spacing={3}>
              <Grid item xs={12} sm={6}>
                <Grid container spacing={3}>
                  <Grid item xs={6} sm={6}>
                    <TextField  
                      error={hasError('name')}
                      fullWidth
                      helperText={hasError('name') ? formState.errors.name[0] : null}
                      label="Setup Name"
                      name="name"
                      onChange={handleChange}
                      value={formState.values.name || ''}
                      variant="outlined"
                      size="small"
                    />
                  </Grid>  
                  <Grid item xs={6} sm={6}>
                    <ClientDropdown
                      ClientValue={ClientValue}
                      setClientValue={setClientValue}
                      id="client_id"
                      name="client_id"
                      clientOnChange={clientOnChange}
                      selectedId={formState.values.client_id}
                      renderInput={(params) => <TextField {...params} label="Select Client" variant="outlined" error={hasError('client_id')} helperText={hasError('client_id') ? formState.errors.client_id[0] : null} />}
                    />
                  </Grid>
                </Grid> 
                <Grid container spacing={3}>
                  <Grid item xs={12} sm={12}>
                    <CKEditor
                      editor={ ClassicEditor }
                      config={CK_CONFIGS(localStorage.getItem("token"))}
                      data={bulkActivitySetupState.bulkActivitySetupRecord.description || ''}
                      onChange={ ( event, editor ) => {
                        const data = editor.getData();
                        setDescription(data)
                      }}
                    />
                    <FormControl error={hasError('description')} >  
                      <FormHelperText id="component-error-text">{hasError('description') ? formState.errors.description[0] : null}</FormHelperText>
                    </FormControl>
                  </Grid>
                </Grid>   
            </Grid>  
            
              <Grid item xs={12} sm={6}>
                {!isEmpty(bulkActivitySetupState.addedExtraFields)?
                <TableContainer component={Paper} style={{marginBottom: "5px"}}>
                  <Table className={classes.table} aria-label="simple table">
                    <TableHead>
                      <TableRow>
                        <TableCell>Name</TableCell>
                        <TableCell >Label</TableCell>
                        <TableCell align="right"></TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                    {bulkActivitySetupState.addedExtraFields.map(added_extraField => (
                      <TableRow key={added_extraField.name}>
                        <TableCell component="th" scope="row">
                          {added_extraField.name} ({added_extraField.type})
                        </TableCell>
                        <TableCell align="right">
                          <TextField
                            fullWidth
                            label="Extra Field Label"
                            name={added_extraField.name}
                            onChange={handleChange}
                            value={(formState.values[added_extraField.name])? formState.values[added_extraField.name] : added_extraField.field_label}
                            variant="outlined"
                            size="small"
                          />
                        </TableCell>
                        <TableCell align="right">
                        <StyledFab
                          color="bdanger" aria-label="edit"
                          size="small"
                          onClick={() => removeExtraField(added_extraField.name)}
                        >
                          <CloseIcon />
                        </StyledFab>
                        </TableCell>
                      </TableRow>
                    ))}
                    </TableBody>
                  </Table>
                </TableContainer>
                :''}
                <div className={classes.formGroup} >
                  <StyledButton
                    color="bsuccess"
                    type="button"
                    variant="contained"
                    onClick={() => setOpenExtraFieldModel(true)}
                    size="small"
                    startIcon={<AddCircleOutlineIcon />}
                  >
                    Add Extra Fields
                  </StyledButton>
                </div>  
              </Grid>
            </Grid>
          </div>
          
          
          <StyledButton
            color="bprimary"
            disabled={!formState.isValid}
            size="small"
            type="submit"
            variant="contained"
            startIcon={<SaveIcon />}
          >
            Update Activities Import Setup
          </StyledButton>
          &nbsp; &nbsp;
          <StyledButton
            variant="contained"
            color="blight"
            size="small"
            onClick={ ()=>{ dispatch(redirectToBulkActivitySetupList()) } }
            startIcon={<CancelIcon />}
          >
            CLOSE
          </StyledButton>
        </form>
          <ExtraFieldModel 
            modalOpen={openExtraFieldModel} 
            handleModalOpen={setOpenExtraFieldModel}
          />
        </CardContent>
      </Card>
      
    </Page>
  );
};

export default BulkActivitySetupUpdate;
